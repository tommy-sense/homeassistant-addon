#!/usr/bin/with-contenv bashio

# Get the ingress URL from Supervisor API
INGRESS_URL=$(bashio::addon.ingress_url || echo "")
bashio::log.info "Ingress URL: ${INGRESS_URL}"

# Extract just the path part if we got a URL
if [ -n "$INGRESS_URL" ]; then
    INGRESS_PATH=$(echo "$INGRESS_URL" | sed 's|^https\?://[^/]*||')
    INGRESS_PATH="${INGRESS_PATH%/}"
    export INGRESS_PATH
    bashio::log.info "Extracted ingress path: ${INGRESS_PATH}"
fi

# Get ports from configuration
DASHBOARD_PORT=$(bashio::config 'ports.dashboard')
FILE_SERVER_HTTP_PORT=$(bashio::config 'ports.file_server_http')
FILE_SERVER_HTTPS_PORT=$(bashio::config 'ports.file_server_https')
MQTT_PORT=$(bashio::config 'ports.mqtt')
UDP_RELAY_PORT=$(bashio::config 'ports.udp_relay')
WEBSOCKET_SERVER_PORT=$(bashio::config 'ports.websocket_server')

export DASHBOARD_PORT
export FILE_SERVER_HTTP_PORT
export FILE_SERVER_HTTPS_PORT
export MQTT_PORT
export UDP_RELAY_PORT
export WEBSOCKET_SERVER_PORT
bashio::log.info "Dashboard port: ${DASHBOARD_PORT}"
bashio::log.info "File server HTTP port: ${FILE_SERVER_HTTP_PORT}"
bashio::log.info "File server HTTPS port: ${FILE_SERVER_HTTPS_PORT}"
bashio::log.info "MQTT port: ${MQTT_PORT}"
bashio::log.info "UDP relay port: ${UDP_RELAY_PORT}"
bashio::log.info "Websocket server port: ${WEBSOCKET_SERVER_PORT}"

# Start virtual bridge
cd /app || exit
exec ./start.sh